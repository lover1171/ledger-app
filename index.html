<script>
  // =========================
  // Offline Ledger (Final)
  // - 네트워크 사용 코드 없음
  // - CSP로 connect-src 'none' 이므로 fetch/XHR/WebSocket도 원천 차단됨
  // - localStorage만 사용
  // - 기존 가계부 데이터(INLINE_TX) 1회 병합 지원 (앱 구조 변경 없음)
  // =========================

  const START_DATE = "2026-01-01";
  const STORAGE_KEY = "offline_ledger_v1";

  // ✅ [2)에서 복사한 JSON 배열]을 아래에 그대로 붙여넣기
  // 예) const INLINE_TX = [{"id":"tx_...","createdAt":...,"date":"2026-01-01","type":"expense","category":"생활","amount":12000,"memo":"점심"}];
  // 붙여넣기 어려우면 비워둬도 됨(같은 origin이면 기존 localStorage 그대로 읽음)
  const INLINE_TX = [];

  // 인라인 병합 1회만 수행하도록 플래그
  const INLINE_MERGED_FLAG = STORAGE_KEY + "__inline_merged_v1";

  const CATEGORIES = [
    "생활","문화/여가","건강/의료","뷰티","적금","주식","대출","교통",
    "선물","용돈","보험","통신","교육","간식","외식","기타","급여"
  ];

  const WEEKDAY_KO = ["일","월","화","수","목","금","토"];

  // ✅ 주(week)에서 전월/익월 데이터가 섞이는 걸 막고 싶으면 true
  const CLAMP_WEEK_TO_MONTH = true;

  // ====== DOM helper ======
  const $ = (id) => document.getElementById(id);

  // =========================
  // 0) 저장/불러오기 + 병합 유틸
  // =========================
  function normalizeTx(t){
    if(!t) return null;

    if(typeof t.id !== "string" || !t.id) return null;
    if(typeof t.date !== "string" || !/^\d{4}-\d{2}-\d{2}$/.test(t.date)) return null;
    if(t.type !== "income" && t.type !== "expense") return null;
    if(typeof t.category !== "string" || !t.category) return null;

    const amountNum = Number(t.amount);
    if(!isFinite(amountNum) || amountNum < 0) return null;

    const createdAt =
      (typeof t.createdAt === "number" && isFinite(t.createdAt)) ? t.createdAt : Date.now();

    const memo = (typeof t.memo === "string") ? t.memo : "";

    return {
      id: t.id,
      createdAt,
      date: t.date,
      type: t.type,
      category: t.category,
      amount: Math.round(amountNum),
      memo
    };
  }

  function normalizeTxArray(arr){
    if(!Array.isArray(arr)) return [];
    const out = [];
    for(const t of arr){
      const nt = normalizeTx(t);
      if(nt) out.push(nt);
    }
    return out;
  }

  function loadTx(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      return normalizeTxArray(JSON.parse(raw));
    }catch(e){
      return [];
    }
  }

  function saveTx(list){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }catch(e){}
  }

  function mergeTxById(existing, incoming){
    // id 기준 중복 제거 (기존 데이터 우선)
    const map = new Map();
    for(const t of existing) map.set(t.id, t);
    for(const t of incoming){
      if(!map.has(t.id)) map.set(t.id, t);
    }
    return Array.from(map.values());
  }

  function mergeInlineTxOnceIfProvided(){
    // INLINE_TX가 비었으면 아무것도 안 함
    if(!Array.isArray(INLINE_TX) || INLINE_TX.length === 0) return;

    try{
      if(localStorage.getItem(INLINE_MERGED_FLAG) === "1") return;
    }catch(e){
      return;
    }

    const incoming = normalizeTxArray(INLINE_TX);
    const existing = loadTx();

    const merged = mergeTxById(existing, incoming);

    // 날짜/생성시간 기준 정렬(표시에 직접 영향은 없지만 데이터 정돈)
    merged.sort((a,b) => (a.date.localeCompare(b.date) || (a.createdAt - b.createdAt)));

    saveTx(merged);

    try{
      localStorage.setItem(INLINE_MERGED_FLAG, "1");
    }catch(e){}
  }

  // ✅ UI 변경 없이 콘솔로 내보내기/가져오기 도우미 제공
  window.exportLedgerJSON = function(){
    try{
      return localStorage.getItem(STORAGE_KEY) || "[]";
    }catch(e){
      return "[]";
    }
  };
  window.importLedgerJSON = function(jsonString){
    const incoming = normalizeTxArray(JSON.parse(String(jsonString || "[]")));
    const existing = loadTx();
    const merged = mergeTxById(existing, incoming);
    merged.sort((a,b) => (a.date.localeCompare(b.date) || (a.createdAt - b.createdAt)));
    saveTx(merged);
    return merged.length;
  };

  // =========================
  // 1) 날짜 유틸(UTC 안전)
  // =========================
  function pad2(n){ return String(n).padStart(2,"0"); }

  function parseISODateUTC(iso){
    const [y,m,d] = iso.split("-").map(Number);
    return new Date(Date.UTC(y, m - 1, d));
  }

  function toISODateUTC(date){
    return date.toISOString().slice(0, 10);
  }

  function addDays(iso, days){
    const d = parseISODateUTC(iso);
    d.setUTCDate(d.getUTCDate() + days);
    return toISODateUTC(d);
  }

  function weekStart(iso){
    const d = parseISODateUTC(iso);
    const day = d.getUTCDay(); // 0:일 1:월...
    const diff = (day === 0) ? -6 : (1 - day);
    d.setUTCDate(d.getUTCDate() + diff);
    return toISODateUTC(d);
  }

  function isoToPrettyDate(iso){
    const d = parseISODateUTC(iso);
    const y = d.getUTCFullYear();
    const m = pad2(d.getUTCMonth() + 1);
    const day = pad2(d.getUTCDate());
    const w = WEEKDAY_KO[d.getUTCDay()];
    return `${y}.${m}.${day} ${w}`;
  }

  function isoToPrettyYM(ym){
    const [y,m] = ym.split("-");
    return `${y}.${m}`;
  }

  function maxISO(a, b){ return (a > b) ? a : b; }
  function minISO(a, b){ return (a < b) ? a : b; }

  function getMonthRangeByDate(dateISO){
    const ym = dateISO.slice(0,7);
    const start = `${ym}-01`;
    const d = parseISODateUTC(start);
    d.setUTCMonth(d.getUTCMonth() + 1);
    const end = toISODateUTC(d);
    return { start, end };
  }

  function getYearRangeByDate(dateISO){
    const yy = dateISO.slice(0,4);
    const start = `${yy}-01-01`;
    const d = parseISODateUTC(start);
    d.setUTCFullYear(d.getUTCFullYear() + 1);
    const end = toISODateUTC(d);
    return { start, end };
  }

  function getRange(period, dateISO){
    if(period === "day"){
      return { start: dateISO, end: addDays(dateISO, 1) };
    }

    if(period === "week"){
      const start0 = weekStart(dateISO);
      const end0 = addDays(start0, 7);

      if(!CLAMP_WEEK_TO_MONTH) return { start: start0, end: end0 };

      const m = getMonthRangeByDate(dateISO);
      const start = maxISO(start0, m.start);
      const end = minISO(end0, m.end);
      return { start, end };
    }

    if(period === "month"){
      return getMonthRangeByDate(dateISO);
    }

    return getYearRangeByDate(dateISO);
  }

  function inRange(tx, start, end){
    return tx.date >= start && tx.date < end;
  }

  function sumTx(list){
    let income = 0, expense = 0;
    for(const t of list){
      if(t.type === "income") income += t.amount;
      else expense += t.amount;
    }
    return { income, expense };
  }

  function fmtWon(n){
    const v = Math.round(Number(n) || 0);
    return v.toLocaleString("ko-KR") + "원";
  }

  function safeParseAmount(v){
    const n = Number(v);
    if(!isFinite(n) || n < 0) return null;
    return Math.round(n);
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // =========================
  // 2) 상태 (인라인 병합 -> 로드)
  // =========================
  mergeInlineTxOnceIfProvided();

  let transactions = loadTx();
  let selectedDate = START_DATE;

  let detailPeriod = "day";
  let detailCategory = "all";
  let detailType = "all";

  let rankPeriod = "day";

  // =========================
  // 3) 기준 날짜 변경
  // =========================
  function setSelectedDate(nextISO){
    if(!nextISO || nextISO < START_DATE) return;
    selectedDate = nextISO;
    refreshAll();
  }

  function setSelectedMonth(ym){
    if(!ym) return;
    if(ym < START_DATE.slice(0,7)) return;
    setSelectedDate(`${ym}-01`);
  }

  function setSelectedYear(yy){
    const v = String(yy || "").trim();
    if(!/^\d{4}$/.test(v) || Number(v) < 2026) return;
    setSelectedDate(`${v}-01-01`);
  }

  // =========================
  // 4) 상단 요약
  // =========================
  function updateTopSummary(){
    $("selectedDate").value = selectedDate;
    $("selectedDatePretty").textContent = isoToPrettyDate(selectedDate);

    const rDay = getRange("day", selectedDate);
    const rWeek = getRange("week", selectedDate);
    const rMonth = getRange("month", selectedDate);
    const rYear = getRange("year", selectedDate);

    const txDay = transactions.filter(t => inRange(t, rDay.start, rDay.end));
    const txWeek = transactions.filter(t => inRange(t, rWeek.start, rWeek.end));
    const txMonth = transactions.filter(t => inRange(t, rMonth.start, rMonth.end));
    const txYear = transactions.filter(t => inRange(t, rYear.start, rYear.end));

    const sDay = sumTx(txDay);
    const sWeek = sumTx(txWeek);
    const sMonth = sumTx(txMonth);
    const sYear = sumTx(txYear);

    $("sumDayIncome").textContent = fmtWon(sDay.income);
    $("sumDayExpense").textContent = fmtWon(sDay.expense);

    $("sumWeekIncome").textContent = fmtWon(sWeek.income);
    $("sumWeekExpense").textContent = fmtWon(sWeek.expense);

    $("sumMonthIncome").textContent = fmtWon(sMonth.income);
    $("sumMonthExpense").textContent = fmtWon(sMonth.expense);

    $("sumYearIncome").textContent = fmtWon(sYear.income);
    $("sumYearExpense").textContent = fmtWon(sYear.expense);

    $("txDate").value = selectedDate;
  }

  // =========================
  // 5) 세부항목
  // =========================
  function applyDetailFilterStateToInputs(){
    $("filterDayWrap").classList.toggle("hide", detailPeriod !== "day");
    $("filterWeekWrap").classList.toggle("hide", detailPeriod !== "week");
    $("filterMonthWrap").classList.toggle("hide", detailPeriod !== "month");
    $("filterYearWrap").classList.toggle("hide", detailPeriod !== "year");

    $("detailDay").value = selectedDate;
    $("detailWeek").value = selectedDate;
    $("detailMonth").value = selectedDate.slice(0,7);
    $("detailYear").value = selectedDate.slice(0,4);

    $("detailCategory").value = detailCategory;
    $("detailType").value = detailType;

    const chips = document.querySelectorAll("#categoryChips .chip");
    chips.forEach(ch => {
      const v = ch.getAttribute("data-val");
      ch.classList.toggle("active", v === detailCategory);
    });
  }

  function getFilteredTxForDetail(){
    const range = getRange(detailPeriod, selectedDate);
    let list = transactions.filter(t => inRange(t, range.start, range.end));

    if(detailCategory !== "all") list = list.filter(t => t.category === detailCategory);
    if(detailType !== "all") list = list.filter(t => t.type === detailType);

    list.sort((a,b) => (b.date.localeCompare(a.date) || b.createdAt - a.createdAt));
    return list;
  }

  function renderBuckets(list){
    const map = new Map();
    for(const t of list){
      const key = (detailPeriod === "year") ? t.date.slice(0,7) : t.date;
      if(!map.has(key)) map.set(key, { income:0, expense:0 });
      const bucket = map.get(key);
      if(t.type === "income") bucket.income += t.amount;
      else bucket.expense += t.amount;
    }

    const keys = Array.from(map.keys()).sort();
    const tbody = $("bucketBody");
    tbody.innerHTML = "";

    if(keys.length === 0){
      tbody.innerHTML = `<tr><td colspan="3" class="center" style="color:var(--muted); font-weight:900;">데이터 없음</td></tr>`;
      return;
    }

    for(const k of keys){
      const v = map.get(k);
      const label = (detailPeriod === "year") ? isoToPrettyYM(k) : isoToPrettyDate(k);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${label}</td>
        <td class="right income">${fmtWon(v.income)}</td>
        <td class="right expense">${fmtWon(v.expense)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderTxTable(list){
    const tbody = $("txBody");
    tbody.innerHTML = "";

    if(list.length === 0){
      tbody.innerHTML = `<tr><td colspan="6" class="center" style="color:var(--muted); font-weight:900;">데이터 없음</td></tr>`;
      return;
    }

    for(const t of list){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${isoToPrettyDate(t.date)}</td>
        <td><span class="badge ${t.type}">${t.type === "income" ? "수익" : "지출"}</span></td>
        <td>${t.category}</td>
        <td class="right ${t.type}">${fmtWon(t.amount)}</td>
        <td>${escapeHtml(t.memo || "")}</td>
        <td class="center">
          <button class="dangerBtn" type="button" data-del="${t.id}">삭제</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    tbody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-del");
        transactions = transactions.filter(x => x.id !== id);
        saveTx(transactions);
        refreshAll();
      });
    });
  }

  function renderCategorySummary(list){
    const tbody = $("catSumBody");
    tbody.innerHTML = "";

    const map = new Map();
    for(const c of CATEGORIES) map.set(c, { income:0, expense:0 });

    for(const t of list){
      if(!map.has(t.category)) map.set(t.category, {income:0, expense:0});
      const row = map.get(t.category);
      if(t.type === "income") row.income += t.amount;
      else row.expense += t.amount;
    }

    const any = Array.from(map.values()).some(v => v.income>0 || v.expense>0);
    if(!any){
      tbody.innerHTML = `<tr><td colspan="3" class="center" style="color:var(--muted); font-weight:900;">데이터 없음</td></tr>`;
      return;
    }

    for(const c of CATEGORIES){
      const v = map.get(c);
      if(v.income === 0 && v.expense === 0) continue;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c}</td>
        <td class="right income">${fmtWon(v.income)}</td>
        <td class="right expense">${fmtWon(v.expense)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function updateDetailSection(){
    applyDetailFilterStateToInputs();
    const list = getFilteredTxForDetail();
    renderBuckets(list);
    renderTxTable(list);
    renderCategorySummary(list);
  }

  // =========================
  // 6) 순위 페이지
  // =========================
  function applyRankFilterUI(){
    $("rankDayWrap").classList.toggle("hide", rankPeriod !== "day");
    $("rankWeekWrap").classList.toggle("hide", rankPeriod !== "week");
    $("rankMonthWrap").classList.toggle("hide", rankPeriod !== "month");
    $("rankYearWrap").classList.toggle("hide", rankPeriod !== "year");

    $("rankDay").value = selectedDate;
    $("rankWeek").value = selectedDate;
    $("rankMonth").value = selectedDate.slice(0,7);
    $("rankYear").value = selectedDate.slice(0,4);

    $("rankPeriod").value = rankPeriod;
  }

  function getFilteredTxForRank(){
    const range = getRange(rankPeriod, selectedDate);
    return transactions.filter(t => inRange(t, range.start, range.end));
  }

  function renderRankTables(){
    const list = getFilteredTxForRank();

    const sumMap = new Map();
    for(const c of CATEGORIES) sumMap.set(c, { income:0, expense:0 });

    for(const t of list){
      if(!sumMap.has(t.category)) sumMap.set(t.category, {income:0, expense:0});
      const row = sumMap.get(t.category);
      if(t.type === "income") row.income += t.amount;
      else row.expense += t.amount;
    }

    const totalIncome = Array.from(sumMap.values()).reduce((a,v)=>a+v.income,0);
    const totalExpense = Array.from(sumMap.values()).reduce((a,v)=>a+v.expense,0);

    const incomeRows = [];
    for(const [cat, v] of sumMap.entries()){
      if(v.income > 0) incomeRows.push({ cat, amount: v.income });
    }
    incomeRows.sort((a,b)=>b.amount-a.amount);

    const incomeBody = $("incomeRankBody");
    incomeBody.innerHTML = "";
    if(incomeRows.length === 0){
      incomeBody.innerHTML = `<tr><td colspan="4" class="center" style="color:var(--muted); font-weight:900;">데이터 없음</td></tr>`;
    }else{
      incomeRows.forEach((r, idx) => {
        const pct = totalIncome ? (r.amount / totalIncome * 100) : 0;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="center" style="font-weight:900;">${idx+1}</td>
          <td>${r.cat}</td>
          <td class="right income" style="font-weight:900;">${fmtWon(r.amount)}</td>
          <td>
            <div class="barWrap" title="${pct.toFixed(1)}%">
              <div class="bar" style="width:${Math.min(100,pct).toFixed(2)}%"></div>
            </div>
            <div class="note">${pct.toFixed(1)}%</div>
          </td>
        `;
        incomeBody.appendChild(tr);
      });
    }

    const expenseRows = [];
    for(const [cat, v] of sumMap.entries()){
      if(v.expense > 0) expenseRows.push({ cat, amount: v.expense });
    }
    expenseRows.sort((a,b)=>b.amount-a.amount);

    const expenseBody = $("expenseRankBody");
    expenseBody.innerHTML = "";
    if(expenseRows.length === 0){
      expenseBody.innerHTML = `<tr><td colspan="4" class="center" style="color:var(--muted); font-weight:900;">데이터 없음</td></tr>`;
    }else{
      expenseRows.forEach((r, idx) => {
        const pct = totalExpense ? (r.amount / totalExpense * 100) : 0;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="center" style="font-weight:900;">${idx+1}</td>
          <td>${r.cat}</td>
          <td class="right expense" style="font-weight:900;">${fmtWon(r.amount)}</td>
          <td>
            <div class="barWrap" title="${pct.toFixed(1)}%">
              <div class="bar expense" style="width:${Math.min(100,pct).toFixed(2)}%"></div>
            </div>
            <div class="note">${pct.toFixed(1)}%</div>
          </td>
        `;
        expenseBody.appendChild(tr);
      });
    }
  }

  // =========================
  // 7) UI 초기화
  // =========================
  function initCategorySelects(){
    const txCat = $("txCategory");
    txCat.innerHTML = "";
    for(const c of CATEGORIES){
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      txCat.appendChild(opt);
    }

    const detCat = $("detailCategory");
    detCat.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "all";
    optAll.textContent = "전체";
    detCat.appendChild(optAll);

    for(const c of CATEGORIES){
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      detCat.appendChild(opt);
    }

    const chipRow = $("categoryChips");
    chipRow.innerHTML = "";
    const allChip = document.createElement("button");
    allChip.type="button";
    allChip.className = "chip active";
    allChip.textContent = "전체";
    allChip.setAttribute("data-val","all");
    chipRow.appendChild(allChip);

    for(const c of CATEGORIES){
      const ch = document.createElement("button");
      ch.type="button";
      ch.className = "chip";
      ch.textContent = c;
      ch.setAttribute("data-val", c);
      chipRow.appendChild(ch);
    }

    chipRow.querySelectorAll(".chip").forEach(ch => {
      ch.addEventListener("click", () => {
        detailCategory = ch.getAttribute("data-val");
        $("detailCategory").value = detailCategory;
        updateDetailSection();
      });
    });
  }

  function initDateInputs(){
    $("selectedDate").min = START_DATE;
    $("txDate").min = START_DATE;

    $("detailDay").min = START_DATE;
    $("detailWeek").min = START_DATE;

    $("detailMonth").min = START_DATE.slice(0,7);
    $("rankMonth").min = START_DATE.slice(0,7);

    $("rankDay").min = START_DATE;
    $("rankWeek").min = START_DATE;
  }

  // =========================
  // 8) 이벤트
  // =========================
  function bindEvents(){
    $("nav-ledger").addEventListener("click", () => showPage("ledger"));
    $("nav-rank").addEventListener("click", () => showPage("rank"));

    $("btnPrevDay").addEventListener("click", () => {
      const next = addDays(selectedDate, -1);
      if(next < START_DATE) return;
      setSelectedDate(next);
    });
    $("btnNextDay").addEventListener("click", () => {
      setSelectedDate(addDays(selectedDate, 1));
    });
    $("selectedDate").addEventListener("change", (e) => {
      setSelectedDate(e.target.value);
    });

    $("txForm").addEventListener("submit", (e) => {
      e.preventDefault();

      const date = $("txDate").value;
      const type = $("txType").value;
      const category = $("txCategory").value;
      const amount = safeParseAmount($("txAmount").value);
      const memo = $("txMemo").value.trim();

      if(!date || date < START_DATE){
        alert("날짜를 확인해줘 (2026-01-01 이후).");
        return;
      }
      if(amount === null){
        alert("금액을 숫자로 입력해줘.");
        return;
      }

      const tx = {
        id: "tx_" + Date.now() + "_" + Math.random().toString(16).slice(2),
        createdAt: Date.now(),
        date,
        type,
        category,
        amount,
        memo
      };

      transactions.push(tx);
      saveTx(transactions);

      $("txAmount").value = "";
      $("txMemo").value = "";

      refreshAll();
    });

    document.querySelectorAll(".tabBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        detailPeriod = btn.getAttribute("data-period");
        document.querySelectorAll(".tabBtn").forEach(b => b.classList.toggle("active", b === btn));
        updateDetailSection();
      });
    });

    $("detailDay").addEventListener("change", (e) => {
      if(detailPeriod !== "day") return;
      setSelectedDate(e.target.value);
    });
    $("detailWeek").addEventListener("change", (e) => {
      if(detailPeriod !== "week") return;
      setSelectedDate(e.target.value);
    });
    $("detailMonth").addEventListener("change", (e) => {
      if(detailPeriod !== "month") return;
      setSelectedMonth(e.target.value);
    });
    $("detailYear").addEventListener("change", (e) => {
      if(detailPeriod !== "year") return;
      setSelectedYear(e.target.value);
    });

    $("detailCategory").addEventListener("change", (e) => {
      detailCategory = e.target.value;
      updateDetailSection();
    });
    $("detailType").addEventListener("change", (e) => {
      detailType = e.target.value;
      updateDetailSection();
    });

    $("rankPeriod").addEventListener("change", (e) => {
      rankPeriod = e.target.value;
      applyRankFilterUI();
      renderRankTables();
    });

    $("rankDay").addEventListener("change", (e) => {
      if(rankPeriod !== "day") return;
      setSelectedDate(e.target.value);
    });
    $("rankWeek").addEventListener("change", (e) => {
      if(rankPeriod !== "week") return;
      setSelectedDate(e.target.value);
    });
    $("rankMonth").addEventListener("change", (e) => {
      if(rankPeriod !== "month") return;
      setSelectedMonth(e.target.value);
    });
    $("rankYear").addEventListener("change", (e) => {
      if(rankPeriod !== "year") return;
      setSelectedYear(e.target.value);
    });
  }

  function showPage(which){
    const isLedger = (which === "ledger");
    $("page-ledger").classList.toggle("active", isLedger);
    $("page-rank").classList.toggle("active", !isLedger);

    $("nav-ledger").classList.toggle("active", isLedger);
    $("nav-rank").classList.toggle("active", !isLedger);

    if(!isLedger){
      applyRankFilterUI();
      renderRankTables();
    }
  }

  function refreshAll(){
    // 저장/삭제 후 최신 로드(안전)
    transactions = loadTx();

    updateTopSummary();
    applyDetailFilterStateToInputs();
    updateDetailSection();
    applyRankFilterUI();
    renderRankTables();
  }

  // =========================
  // 9) 초기 실행
  // =========================
  (function init(){
    initCategorySelects();
    initDateInputs();
    bindEvents();
    setSelectedDate(START_DATE);
  })();
  </script>
